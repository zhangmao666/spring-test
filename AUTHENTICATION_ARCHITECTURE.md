# è®¤è¯æ¶æ„è¯´æ˜

## ğŸ“ æ¶æ„æ¦‚è§ˆ

æœ¬é¡¹ç›®å®ç°äº†**åŒè®¤è¯ä½“ç³»**ï¼Œæ”¯æŒä¸åŒåœºæ™¯çš„è®¿é—®éœ€æ±‚ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è®¤è¯æ¶æ„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç”¨æˆ·JWTè®¤è¯         â”‚      â”‚  OAuth2å®¢æˆ·ç«¯è®¤è¯         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ğŸ‘¤ Web/ç§»åŠ¨ç«¯ç”¨æˆ·    â”‚      â”‚ ğŸ¢ ç¬¬ä¸‰æ–¹å…¬å¸/æœåŠ¡        â”‚  â”‚
â”‚  â”‚ ğŸ“ /auth/login      â”‚      â”‚ ğŸ“ /oauth2/token         â”‚  â”‚
â”‚  â”‚ ğŸ”‘ è‡ªå®šä¹‰JWT         â”‚      â”‚ ğŸ”‘ æ ‡å‡†OAuth2 JWT        â”‚  â”‚
â”‚  â”‚ âœï¸  HMACç­¾å         â”‚      â”‚ âœï¸  RSAç­¾å              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                             â†“                   â”‚
â”‚  JwtAuthenticationFilter      OAuth2 Resource Server       â”‚
â”‚           â†“                             â†“                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                  Spring Security Context                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” è®¤è¯æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | ç”¨æˆ·JWTè®¤è¯ | OAuth2å®¢æˆ·ç«¯è®¤è¯ |
|-----|-----------|----------------|
| **é€‚ç”¨åœºæ™¯** | äººæœºäº¤äº’ï¼ˆWeb/Appï¼‰ | æœºå™¨å¯¹æœºå™¨ï¼ˆM2Mï¼‰ |
| **è®¤è¯ç«¯ç‚¹** | `/auth/login` | `/oauth2/token` |
| **å‡­è¯ç±»å‹** | username + password | client_id + client_secret |
| **Tokenç­¾å** | HMAC-SHA256 | RSA-2048 |
| **Tokenç±»å‹** | è‡ªå®šä¹‰JWT | æ ‡å‡†OAuth2 JWT |
| **éªŒè¯æ–¹å¼** | JwtAuthenticationFilter | OAuth2 Resource Server |
| **æ ‡å‡†åŒ–** | è‡ªå®šä¹‰ | OAuth 2.1æ ‡å‡† |
| **ç¬¬ä¸‰æ–¹é›†æˆ** | âŒ | âœ… |

---

## ğŸ¯ æ–¹å¼1ï¼šç”¨æˆ·JWTè®¤è¯

### **ä½¿ç”¨åœºæ™¯**
- Webå‰ç«¯ç”¨æˆ·ç™»å½•
- ç§»åŠ¨Appç”¨æˆ·ç™»å½•
- å†…éƒ¨å‘˜å·¥ç³»ç»Ÿè®¿é—®

### **å·¥ä½œæµç¨‹**

```
1. ç”¨æˆ·æäº¤ username + password
   â†“
2. UserServiceéªŒè¯å‡­è¯
   â†“
3. JwtUtilç”Ÿæˆè‡ªå®šä¹‰JWT Token
   â†“
4. è¿”å›Tokenç»™å‰ç«¯
   â†“
5. å‰ç«¯æ¯æ¬¡è¯·æ±‚æºå¸¦: Authorization: Bearer <token>
   â†“
6. JwtAuthenticationFilteréªŒè¯Token
   â†“
7. è®¾ç½®Spring Securityä¸Šä¸‹æ–‡
```

### **ç¤ºä¾‹ä»£ç **

```powershell
# ç™»å½•
$response = Invoke-RestMethod -Uri "http://localhost:8879/api/auth/login" `
    -Method Post `
    -ContentType "application/json" `
    -Body (@{
        username = "admin"
        password = "admin123"
    } | ConvertTo-Json)

$userToken = $response.data.token

# ä½¿ç”¨Tokenè°ƒç”¨API
Invoke-RestMethod -Uri "http://localhost:8879/api/files/list" `
    -Headers @{"Authorization" = "Bearer $userToken"}
```

---

## ğŸ¢ æ–¹å¼2ï¼šOAuth2å®¢æˆ·ç«¯è®¤è¯

### **ä½¿ç”¨åœºæ™¯**
- ç¬¬ä¸‰æ–¹å…¬å¸é›†æˆ
- å¾®æœåŠ¡é—´è°ƒç”¨
- å®šæ—¶ä»»åŠ¡/æ‰¹å¤„ç†è„šæœ¬
- æœåŠ¡ç«¯å¯¹æœåŠ¡ç«¯ï¼ˆServer-to-Serverï¼‰

### **å·¥ä½œæµç¨‹**

```
1. å®¢æˆ·ç«¯æäº¤ client_id + client_secret
   â†“
2. OAuth2æˆæƒæœåŠ¡å™¨éªŒè¯å‡­è¯
   â†“
3. ç”Ÿæˆæ ‡å‡†OAuth2 JWT Tokenï¼ˆRSAç­¾åï¼‰
   â†“
4. è¿”å›access_token
   â†“
5. å®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚æºå¸¦: Authorization: Bearer <token>
   â†“
6. OAuth2 Resource ServeréªŒè¯Token
   â†“
7. è®¾ç½®Spring Securityä¸Šä¸‹æ–‡
```

### **ç¤ºä¾‹ä»£ç **

```powershell
# è·å–OAuth2 Token
$credentials = "client_id:client_secret"
$basicAuth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes($credentials))

$response = Invoke-RestMethod -Uri "http://localhost:8879/api/oauth2/token" `
    -Method Post `
    -Headers @{
        "Authorization" = "Basic $basicAuth"
        "Content-Type" = "application/x-www-form-urlencoded"
    } `
    -Body "grant_type=client_credentials"

$oauth2Token = $response.access_token

# ä½¿ç”¨Tokenè°ƒç”¨API
Invoke-RestMethod -Uri "http://localhost:8879/api/files/list" `
    -Headers @{"Authorization" = "Bearer $oauth2Token"}
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### **æ ¸å¿ƒç»„ä»¶**

#### 1. **ç”¨æˆ·è®¤è¯é“¾**
```
AuthController
    â†“
UserService (éªŒè¯å¯†ç )
    â†“
JwtUtil (ç”ŸæˆHMAC JWT)
    â†“
JwtAuthenticationFilter (éªŒè¯Token)
```

#### 2. **OAuth2è®¤è¯é“¾**
```
OAuth2AuthorizationServerConfig
    â†“
MybatisRegisteredClientRepository (éªŒè¯clientå‡­è¯)
    â†“
OAuth2 Token Endpoint (ç”ŸæˆRSA JWT)
    â†“
OAuth2 Resource Server (éªŒè¯Token)
```

### **å…³é”®æ–‡ä»¶**

```
src/main/java/com/example/springboottest/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ SecurityConfig.java                    # ä¸»å®‰å…¨é…ç½®
â”‚   â”œâ”€â”€ OAuth2AuthorizationServerConfig.java   # OAuth2æœåŠ¡å™¨é…ç½®
â”‚   â”œâ”€â”€ JwtAuthenticationFilter.java           # ç”¨æˆ·JWTè¿‡æ»¤å™¨
â”‚   â””â”€â”€ RegisteredClientConfig.java            # OAuth2å®¢æˆ·ç«¯é…ç½®
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ AuthController.java                    # ç”¨æˆ·ç™»å½•æ¥å£
â”œâ”€â”€ service/
â”‚   â””â”€â”€ UserService.java                       # ç”¨æˆ·è®¤è¯æœåŠ¡
â”œâ”€â”€ util/
â”‚   â””â”€â”€ JwtUtil.java                           # JWTå·¥å…·ç±»
â””â”€â”€ repository/
    â”œâ”€â”€ ApiClientRepository.java               # OAuth2å®¢æˆ·ç«¯å­˜å‚¨
    â””â”€â”€ MybatisRegisteredClientRepository.java # OAuth2å®¢æˆ·ç«¯é€‚é…å™¨
```

---

## ğŸ”„ ä¸ºä»€ä¹ˆä½¿ç”¨åŒè®¤è¯ä½“ç³»ï¼Ÿ

### **åŸæ–¹æ¡ˆé—®é¢˜**
âŒ å­˜åœ¨3ç§è®¤è¯æ–¹å¼ï¼ˆç”¨æˆ·JWTã€è‡ªå®šä¹‰APIå®¢æˆ·ç«¯ã€OAuth2ï¼‰  
âŒ è‡ªå®šä¹‰APIå®¢æˆ·ç«¯ä¸OAuth2åŠŸèƒ½é‡å¤  
âŒ ç¬¬ä¸‰æ–¹éœ€è¦å­¦ä¹ è‡ªå®šä¹‰åè®®  
âŒ ç»´æŠ¤æˆæœ¬é«˜  

### **ç°æ–¹æ¡ˆä¼˜åŠ¿**
âœ… æ¸…æ™°çš„èŒè´£åˆ’åˆ†ï¼šç”¨æˆ·ç”¨JWTï¼Œç¬¬ä¸‰æ–¹ç”¨OAuth2  
âœ… ç¬¦åˆè¡Œä¸šæ ‡å‡†ï¼Œç¬¬ä¸‰æ–¹å®¹æ˜“é›†æˆ  
âœ… å‡å°‘ç»´æŠ¤æˆæœ¬  
âœ… ä¿æŒçµæ´»æ€§  

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **[OAuth2 ç¬¬ä¸‰æ–¹é›†æˆæŒ‡å—](OAUTH2_INTEGRATION_GUIDE.md)** - ç¬¬ä¸‰æ–¹å…¬å¸å¿…è¯»
- **[ç”¨æˆ·è®¤è¯æµ‹è¯•è„šæœ¬](test_ai.ps1)** - ç”¨æˆ·JWTè®¤è¯ç¤ºä¾‹
- **[OAuth2æµ‹è¯•è„šæœ¬](test_oauth2_token.ps1)** - OAuth2è®¤è¯ç¤ºä¾‹

---

## ğŸ”’ å®‰å…¨é…ç½®çŠ¶æ€

å½“å‰SecurityConfigä¸­çš„è®¤è¯é…ç½®ï¼š

```java
// âš ï¸ å¼€å‘ç¯å¢ƒï¼šæ‰€æœ‰æ¥å£æš‚æ—¶å¼€æ”¾
.anyRequest().permitAll()

// ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ï¼š
.authorizeHttpRequests(auth -> auth
    .requestMatchers("/auth/**").permitAll()      // ç”¨æˆ·ç™»å½•æ¥å£
    .requestMatchers("/oauth2/**").permitAll()    // OAuth2æ¥å£
    .requestMatchers("/health").permitAll()       // å¥åº·æ£€æŸ¥
    .anyRequest().authenticated()                 // å…¶ä»–éœ€è¦è®¤è¯
)
```

**ä¸Šçº¿å‰åŠ¡å¿…å¯ç”¨ç”Ÿäº§é…ç½®ï¼**

---

**æœ€åæ›´æ–°æ—¶é—´**ï¼š2025-11-18
